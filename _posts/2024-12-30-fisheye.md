---
layout: post
title: "Fisheye"
date: 2024-12-30 23:44:47 +0800
categories: []
description: 简要介绍
tags: 
thumbnail: 
toc:
  sidebar: left # or right
typora-root-url: ../
---

---
title: 鱼眼镜头去变形和校正 fisheye
banner_img: /img/jmu.jpg
banner_img_height: 50
math: true
date: 2023-08-11 23:45:49
tags:
---

参考：

[Tutorial on Computer Vision with Fisheye Cameras](https://plaut.github.io/fisheye_tutorial/#the-fisheye-projection)

[OpenCV Fisheye camera model](https://docs.opencv.org/4.8.0/db/d58/group__calib3d__fisheye.html)

## 鱼眼相机投影模型

有多种被称为鱼眼的投影方式，包括等距、等固角、立体和正交投影。OpenCV 使用"等距鱼眼"相机模型。

具有相同的入射角 $$\theta$$ 的三维点（组成cone）被投影到鱼眼图像中距离主点一定距离 $$r$$ 处（组成一个圆）。这个性质我猜对不同的投影方式都是成立的。区别在于 $$r$$ 和 $$\theta$$ 的关系。

- equidistant fisheye model：the distance between a pixel in the image and the principal point is directly proportional to the angle of incidence $$r=f\theta$$.
- In the equisolid fisheye projection $$r=2f\sin \frac{\theta}{2}$$,
- in the stereographic fisheye projection $$r=2f\tan \frac{\theta}{2}$$ 
- and in the orthographic fisheye projection $$r=f\sin \theta$$.

### 等距鱼眼投影

OpenCV 描述

![image-20230812001447747](/images/2024-12-30-fisheye/image-20230812001447747.png){: .img-fluid}

可以看出

1. 先计算入射角 $$\theta$$
2. 若有鱼眼失真，计算失真后的 $$\theta_d$$
3. 鱼眼投影，投影到假象的单位距离焦平面
4. 根据相机内参，形成二维图像（相机内参可以理解成传感器成像时的性质）

## OpenCV 函数

###  cv::fisheye::calibrate

使用黑白格子图，标定鱼眼相机，输出K（camera intrinsic matrix），D（向量，$$k_1,k_2,k_3,k_4$$）

### cv.fisheye.initUndistortRectifyMap

cv.fisheye.initUndistortRectifyMap(	K, D, R, P, size, m1type[, map1[, map2]]	) ->	map1, map2

Computes undistortion and rectification maps for image transform by *remap*. 求解后的两个 map 在 remap 函数中使用。

- K，D 是鱼眼相机的参数，可以通过 calibrate 函数获得。

- R	Rectification transformation in the object space: 3x3 1-channel, or vector: 3x1/1x3 1-channel or 1x1 3-channel。矫正时在物体空间中的变换。这个不就是我们想要的吗？
- P	New camera intrinsic matrix (3x3) or new projection matrix (3x4) 这个是相机内参，相机内参控制 focal length、skew、principal point。

### cv.fisheye.undistortImage

cv.fisheye.undistortImage(	distorted, K, D[, undistorted[, Knew[, new_size]]]	) ->	undistorted

这个函数是综合了 initUndistortRectifyMap 和 remap。但是少了一些控制参数，比如3维空间中的旋转。

## 去失真和校正

1. 拍摄黑白格子图，使用 calibrate 函数就K，D
2. 使用 initUndistortRectifyMap 计算映射
3. 调用 remap

### 控制焦距

通过 P 参数可以控制焦距，达到类似 zoom in/out 的效果。

### 外部旋转

通过 R 参数可以控制场景旋转，或者说控制相机旋转，以使得校正后的图像能看到鱼眼图像的某一个部分。

一个应用是获得相机分别向左、向右旋转观察到的两张图，然后把这两张图 stitch，形成一张大图。

[参见这儿。](https://plaut.github.io/fisheye_tutorial/#multiple-rectifications)

## 数据集

WoodScape: A multi-task, multi-camera fisheye dataset for autonomous driving

[Github](https://github.com/valeoai/WoodScape)

> 鱼眼相机通常用于在监控、增强现实和特别是汽车应用中获取大视野。尽管它们很常见，但很少有公开的数据集可用于对鱼眼图像上的计算机视觉算法进行详细评估。我们发布了第一个广泛的鱼眼汽车数据集，名为WoodScape，以纪念罗伯特·伍德（Robert Wood），他在1906年发明了鱼眼相机。WoodScape包括四个全景相机和九个任务，包括分割、深度估计、3D边界框检测和污染检测。对于超过10,000张图像，提供了40个类别的语义实例级别的注释，其他任务的注释提供了超过100,000张图像。通过WoodScape，我们希望鼓励社区在使用天真的矫正方法之前，为鱼眼相机调整计算机视觉模型。

